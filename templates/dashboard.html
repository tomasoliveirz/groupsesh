{% extends "base.html" %}

{% block title %}{{ _('Dashboard') }} - {{ survey.title }}{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/calendar.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/admin.css') }}" rel="stylesheet">

<style>
    .participant-card {
        cursor: pointer;
        transition: all 0.2s;
    }
    .participant-card:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    .fc-day-has-participants {
        position: relative;
    }
    .fc-day-has-participants:after {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 0 12px 12px 0;
        border-color: transparent #198754 transparent transparent;
    }
    .participant-count {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: #198754;
        color: white;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 12px;
        line-height: 22px;
        text-align: center;
    }
    .highlight-participants .fc-daygrid-day-frame {
        transition: background-color 0.3s;
    }
    .highlight-participants[data-count="0"] .fc-daygrid-day-frame {
        background-color: #f8d7da !important;
    }
    .highlight-participants[data-count="1"] .fc-daygrid-day-frame {
        background-color: #fff3cd !important;
    }
    .highlight-participants[data-count="2"] .fc-daygrid-day-frame {
        background-color: #d1e7dd !important;
    }
    .highlight-participants[data-count="3"] .fc-daygrid-day-frame,
    .highlight-participants[data-count="4"] .fc-daygrid-day-frame,
    .highlight-participants[data-count="5+"] .fc-daygrid-day-frame {
        background-color: #bfe5c7 !important;
    }
    .admin-badge {
        background-color: #4F46E5;
        color: white;
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 1rem;
        margin-left: 0.5rem;
        display: inline-block;
        vertical-align: middle;
    }
    .admin-participant {
        border-left: 3px solid #4F46E5;
    }
</style>
{% endblock %}

{% block content %}
<!-- Survey Expired Message -->
{% if is_expired %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>{{ _('Attention:') }}</strong> {{ _('This survey has expired. Participants can no longer respond, but you can still view the results.') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div class="row justify-content-center">
    <div class="col-lg-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h2 class="mb-0">{{ survey.title }}</h2>
                
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-light btn-sm" id="share-btn">
                        <i class="bi bi-share-fill"></i> {{ _('Share') }}
                    </button>
                    <button type="button" class="btn btn-light btn-sm" id="export-btn">
                        <i class="bi bi-download"></i> {{ _('Export') }}
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <!-- Survey Actions Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">{{ _('Survey Actions') }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" id="share-survey-btn">
                                        <i class="bi bi-share-fill me-2"></i>{{ _('Share Survey') }}
                                    </button>
                                    <button class="btn btn-outline-info" id="export-results-btn">
                                        <i class="bi bi-download me-2"></i>{{ _('Export Results') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Survey Information Card -->
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">{{ _('Survey Information') }}</h5>
                            </div>
                            <div class="card-body">
                                {% if survey.description %}
                                <p class="card-text">{{ survey.description }}</p>
                                <hr>
                                {% endif %}
                                
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ _('Created by:') }}</span>
                                        <strong>{{ survey.admin_name }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ _('Creation date:') }}</span>
                                        <strong id="creation-date">{{ survey.created_at|date_format }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ _('Expiry date:') }}</span>
                                        <strong id="expiry-date">{{ survey.expires_at|date_format }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ _('Total participants:') }}</span>
                                        <strong id="participants-count">{{ _('Calculating...') }}</strong>
                                    </li>
                                </ul>
                                
                                <div class="mt-3">
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">{{ _('Participant Link') }}</span>
                                        <input type="text" class="form-control" id="survey-link" readonly value="{{ url_for('join_survey_page', token=survey.token, lang_code=language_code, _external=True) }}">
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="copyToClipboard('survey-link')">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" id="dashboard-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="calendar-tab" data-bs-toggle="tab" 
                                                data-bs-target="#calendar-tab-pane" type="button" role="tab" 
                                                aria-controls="calendar-tab-pane" aria-selected="true">
                                            {{ _('Calendar') }}
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="participants-tab" data-bs-toggle="tab" 
                                                data-bs-target="#participants-tab-pane" type="button" role="tab" 
                                                aria-controls="participants-tab-pane" aria-selected="false">
                                            {{ _('Participants') }}
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content" id="dashboard-tabs-content">
                                    <div class="tab-pane fade show active" id="calendar-tab-pane" role="tabpanel" 
                                         aria-labelledby="calendar-tab" tabindex="0">
                                        
                                        <div class="d-flex justify-content-between mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="highlight-switch">
                                                <label class="form-check-label" for="highlight-switch">
                                                    {{ _('Highlight availabilities') }}
                                                </label>
                                            </div>
                                            
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="prev-month-btn">
                                                    <i class="bi bi-chevron-left"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="today-btn">
                                                    {{ _('Today') }}
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="next-month-btn">
                                                    <i class="bi bi-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="calendar"></div>
                                    </div>
                                    
                                    <div class="tab-pane fade" id="participants-tab-pane" role="tabpanel" 
                                         aria-labelledby="participants-tab" tabindex="0">
                                        
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="participant-search" 
                                                   placeholder="{{ _('Search participant by name or email...') }}">
                                        </div>
                                        
                                        <div id="participants-list">
                                            <div class="text-center my-5">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">{{ _('Loading...') }}</span>
                                                </div>
                                                <p class="mt-2">{{ _('Loading participants...') }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Participants Modal -->
        <div class="modal fade" id="participants-modal" tabindex="-1" aria-labelledby="participants-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="participants-modal-label">{{ _('Participants for day') }} <span id="modal-date"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modal-participants-list" class="list-group list-group-flush">
                            <!-- Will be filled via JavaScript -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Participant Detail Modal -->
        <div class="modal fade" id="participant-detail-modal" tabindex="-1" aria-labelledby="participant-detail-modal-label" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="participant-detail-modal-label">{{ _('Participant Details') }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="participant-info">
                            <!-- Will be filled via JavaScript -->
                        </div>
                        
                        <div class="mt-3">
                            <h6>{{ _('Available days:') }}</h6>
                            <div id="participant-dates" class="list-group list-group-flush">
                                <!-- Will be filled via JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Módulos de utilitários -->
<script src="{{ url_for('static', filename='js/common/validation.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/date-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/ui-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/api.js') }}"></script>

<!-- Bibliotecas externas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<!-- Módulo principal do dashboard -->
<script src="{{ url_for('static', filename='js/pages/dashboard.js') }}"></script>

<!-- Variáveis de configuração para a página -->
<script>
    // Dados iniciais para bootstrapping do dashboard
    window.DASHBOARD_CONFIG = {
        survey: {
            id: {{ survey.id }},
            token: "{{ survey.token }}",
            title: "{{ survey.title }}",
            admin_email: "{{ survey.admin_email }}",
            admin_name: "{{ survey.admin_name }}",
            created_at: "{{ survey.created_at }}",
            expires_at: "{{ survey.expires_at }}"
        },
        language: "{{ language_code }}",
        paths: {
            survey_info: "/api/survey-info/{{ survey.token }}",
            survey_data: "/api/survey-data/{{ survey.token }}"
        }
    };
    
    // Ouvinte para garantir inicialização após transições AJAX
    document.addEventListener('pageContentUpdated', function() {
        if (typeof window.initDashboard === 'function') {
            window.initDashboard();
        }
    });
    
    // Função auxiliar para cópia de texto para clipboard
    // Mantida para compatibilidade com a chamada onclick
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        element.select();
        document.execCommand('copy');
        
        // Visual feedback
        const button = element.nextElementSibling;
        if (button) {
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 2000);
        }
    }

    // Lógica do calendário e interface
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const calendarEl = document.getElementById('calendar');
        const participantsList = document.getElementById('participants-list');
        const participantsCount = document.getElementById('participants-count');
        const creationDate = document.getElementById('creation-date');
        const expiryDate = document.getElementById('expiry-date');
        const modalDate = document.getElementById('modal-date');
        const modalParticipantsList = document.getElementById('modal-participants-list');
        const participantsModal = new bootstrap.Modal(document.getElementById('participants-modal'));
        const participantDetailModal = new bootstrap.Modal(document.getElementById('participant-detail-modal'));
        const participantSearch = document.getElementById('participant-search');
        const highlightSwitch = document.getElementById('highlight-switch');
        const shareSurveyBtn = document.getElementById('share-survey-btn');
        const exportResultsBtn = document.getElementById('export-results-btn');
        
        // Global variables
        let surveyData = null;
        let calendar = null;
        
        // Get current locale from HTML lang attribute
        const currentLocale = document.documentElement.lang || 'en';
        const formatOptions = {
            date: {
                short: { day: '2-digit', month: '2-digit', year: 'numeric' },
                full: { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }
            }
        };
        
        // Date formatting functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString(currentLocale, formatOptions.date.full);
        }
        
        function formatShortDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString(currentLocale, formatOptions.date.short);
        }
        
        // Initialize calendar
        function initCalendar(data) {
            // Map dates to calendar events
            const events = [];
            
            // For each date with participants
            for (const dateStr in data.availability_by_date) {
                const participants = data.availability_by_date[dateStr];
                events.push({
                    start: dateStr,
                    end: dateStr,
                    display: 'background',
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    extendedProps: {
                        participants: participants,
                        count: participants.length
                    }
                });
            }
            
            // Initialize calendar
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridYear'
                },
                views: {
                    dayGridMonth: {
                        buttonText: currentLocale === 'en' ? 'Month' : 'Mês'
                    },
                    dayGridYear: {
                        buttonText: currentLocale === 'en' ? 'Year' : 'Ano',
                        duration: { years: 1 }
                    }
                },
                locale: currentLocale.substring(0, 2), // FullCalendar uses 2-letter locale codes
                height: 'auto',
                events: events,
                eventDidMount: function(info) {
                    if (info.event.extendedProps.count) {
                        const count = info.event.extendedProps.count;
                        
                        // Add class for styling
                        info.el.closest('.fc-daygrid-day').classList.add('fc-day-has-participants');
                        
                        // Add participant counter
                        const countEl = document.createElement('div');
                        countEl.className = 'participant-count';
                        countEl.textContent = count;
                        info.el.closest('.fc-daygrid-day-frame').appendChild(countEl);
                        
                        // Add attribute for conditional highlighting
                        const dayEl = info.el.closest('.fc-daygrid-day');
                        dayEl.classList.add('highlight-participants');
                        
                        // Categorize by number of participants
                        let category = count >= 5 ? '5+' : count.toString();
                        dayEl.setAttribute('data-count', category);
                    }
                },
                dateClick: function(info) {
                    const dateStr = info.dateStr;
                    const participants = data.availability_by_date[dateStr] || [];
                    
                    if (participants.length > 0) {
                        showParticipantsModal(dateStr, participants);
                    }
                }
            });
            
            calendar.render();
            
            // Navigation buttons
            document.getElementById('prev-month-btn').addEventListener('click', function() {
                calendar.prev();
            });
            
            document.getElementById('today-btn').addEventListener('click', function() {
                calendar.today();
            });
            
            document.getElementById('next-month-btn').addEventListener('click', function() {
                calendar.next();
            });
        }
        
        // Show participants modal for a date
        function showParticipantsModal(dateStr, participants) {
            // Format date for modal title
            modalDate.textContent = formatShortDate(dateStr);
            
            // Clear previous list
            modalParticipantsList.innerHTML = '';
            
            // Fill with participants
            if (participants.length === 0) {
                modalParticipantsList.innerHTML = `<div class="text-center py-3">${currentLocale === 'en' ? 'No participants available on this day.' : 'Nenhum participante disponível neste dia.'}</div>`;
            } else {
                participants.forEach(participant => {
                    const participantId = participant.participant_id;
                    const fullParticipant = surveyData.participants[participantId];
                    
                    if (!fullParticipant) {
                        console.warn(`Participant ${participantId} not found in full data`);
                        return;
                    }
                    
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    
                    // Check if this participant is the admin
                    const isAdmin = fullParticipant.is_admin;
                    if (isAdmin) {
                        item.classList.add('admin-participant');
                    }
                    
                    const adminBadge = isAdmin ? `<span class="admin-badge">${currentLocale === 'en' ? 'Admin' : 'Admin'}</span>` : '';
                    
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${participant.name} ${adminBadge}</h6>
                        </div>
                        <p class="mb-1">${participant.email}</p>
                    `;
                    
                    // Event to show participant details
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        showParticipantDetails(fullParticipant);
                    });
                    
                    modalParticipantsList.appendChild(item);
                });
            }
            
            // Show modal
            participantsModal.show();
        }
        
        // Show details of a participant
        function showParticipantDetails(participant) {
            // Close previous modal
            participantsModal.hide();
            
            // Fill information
            const participantInfo = document.getElementById('participant-info');
            
            // Check if this participant is the admin
            const isAdmin = participant.is_admin;
            const adminBadge = isAdmin ? `<span class="admin-badge">${currentLocale === 'en' ? 'Admin' : 'Admin'}</span>` : '';
            
            participantInfo.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">${participant.name} ${adminBadge}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${participant.email}</h6>
                        <p class="card-text">
                            <small class="text-muted">${currentLocale === 'en' ? 'Response submitted on' : 'Resposta enviada em'}: ${formatDate(participant.created_at)}</small>
                        </p>
                    </div>
                </div>
            `;
            
            // Fill available dates
            const datesList = document.getElementById('participant-dates');
            datesList.innerHTML = '';
            
            if (!Array.isArray(participant.availability_dates) || participant.availability_dates.length === 0) {
                datesList.innerHTML = `<div class="text-center py-3">${currentLocale === 'en' ? 'No date selected.' : 'Nenhuma data selecionada.'}</div>`;
            } else {
                // Sort dates
                const sortedDates = [...participant.availability_dates].sort();
                
                sortedDates.forEach(dateStr => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.textContent = formatShortDate(dateStr);
                    datesList.appendChild(item);
                });
            }
            
            // Show modal
            participantDetailModal.show();
        }
        
        // Update participants list
        function updateParticipantsList(participants, filter = '') {
            if (!participantsList) return;
            
            participantsList.innerHTML = '';
            
            if (!participants || typeof participants !== 'object') {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = currentLocale === 'en' ? 'Invalid participant data' : 'Dados de participantes inválidos';
                participantsList.appendChild(errorDiv);
                return;
            }
            
            const participantIds = Object.keys(participants);
            
            if (participantIds.length === 0) {
                participantsList.innerHTML = `
                    <div class="text-center py-5">
                        <div class="display-4 text-muted mb-3">
                            <i class="bi bi-people"></i>
                        </div>
                        <p class="lead">${currentLocale === 'en' ? 'No participants yet.' : 'Nenhum participante ainda.'}</p>
                        <p class="text-muted">${currentLocale === 'en' ? 'Share the survey link to receive responses.' : 'Compartilhe o link da survey para receber respostas.'}</p>
                    </div>
                `;
                return;
            }
            
            // Filter participants
            let filteredIds = participantIds;
            if (filter) {
                const lowerFilter = filter.toLowerCase();
                filteredIds = participantIds.filter(id => {
                    const p = participants[id];
                    if (!p || !p.name || !p.email) return false;
                    
                    return p.name.toLowerCase().includes(lowerFilter) || 
                           p.email.toLowerCase().includes(lowerFilter);
                });
            }
            
            if (filteredIds.length === 0) {
                participantsList.innerHTML = `
                    <div class="text-center py-3">
                        <p>${currentLocale === 'en' ? 'No participant found with the term' : 'Nenhum participante encontrado com o termo'} "${filter}".</p>
                    </div>
                `;
                return;
            }
            
            // Sort by: 1) Admin first, 2) Name alphabetically
            filteredIds.sort((a, b) => {
                const pA = participants[a] || {};
                const pB = participants[b] || {};
                
                // Admin always first
                if (pA.is_admin && !pB.is_admin) return -1;
                if (!pA.is_admin && pB.is_admin) return 1;
                
                // Then by name
                return (pA.name || '').localeCompare(pB.name || '');
            });
            
            // Create list
            const list = document.createElement('div');
            list.className = 'list-group';
            
            filteredIds.forEach(id => {
                const participant = participants[id];
                if (!participant) return;
                
                // Check if this participant is the admin
                const isAdmin = !!participant.is_admin;
                const adminBadge = isAdmin ? `<span class="admin-badge">${currentLocale === 'en' ? 'Admin' : 'Admin'}</span>` : '';
                
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action participant-card';
                if (isAdmin) item.classList.add('admin-participant');
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${participant.name || 'N/A'} ${adminBadge}</h6>
                        <small>${formatShortDate(participant.created_at || new Date())}</small>
                    </div>
                    <p class="mb-1">${participant.email || 'N/A'}</p>
                    <small class="text-muted">
                        ${(participant.availability_dates || []).length} ${(participant.availability_dates || []).length === 1 ? 
                            (currentLocale === 'en' ? 'day available' : 'dia disponível') : 
                            (currentLocale === 'en' ? 'days available' : 'dias disponíveis')}
                    </small>
                `;
                
                // Event to show participant details
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    showParticipantDetails(participant);
                });
                
                list.appendChild(item);
            });
            
            participantsList.appendChild(list);
        }
        
        // Export data to CSV
        function exportToCSV() {
            if (!surveyData || !surveyData.participants) {
                alert(currentLocale === 'en' ? 'Data not available for export' : 'Dados não disponíveis para exportação');
                return;
            }
            
            try {
                // Create CSV header
                let csv = `${currentLocale === 'en' ? 'Name' : 'Nome'},${currentLocale === 'en' ? 'Email' : 'Email'},${currentLocale === 'en' ? 'Response Date' : 'Data de Resposta'},${currentLocale === 'en' ? 'Available Days' : 'Dias Disponíveis'}\n`;
                
                // Add data for each participant
                for (const id in surveyData.participants) {
                    if (Object.prototype.hasOwnProperty.call(surveyData.participants, id)) {
                        const p = surveyData.participants[id];
                        if (!p) continue;
                        
                        const name = p.name || '';
                        const email = p.email || '';
                        const createdAt = p.created_at ? formatDate(p.created_at) : '';
                        
                        let dates = '';
                        if (Array.isArray(p.availability_dates)) {
                            dates = p.availability_dates
                                    .map(d => formatShortDate(d))
                                    .join('; ');
                        }
                        
                        // Escape fields properly for CSV
                        const escapeCsv = (str) => {
                            if (typeof str !== 'string') return '';
                            return `"${str.replace(/"/g, '""')}"`;
                        };
                        
                        csv += `${escapeCsv(name)},${escapeCsv(email)},${escapeCsv(createdAt)},${escapeCsv(dates)}\n`;
                    }
                }
                
                // Generate safe filename
                let filename = 'survey_export_' + new Date().toISOString().slice(0, 10) + '.csv';
                if (surveyData.survey && surveyData.survey.title) {
                    // Replace characters not allowed in filenames
                    const safeTitle = surveyData.survey.title.replace(/[^\w\s-]/g, '_');
                    filename = `survey_${safeTitle}_${new Date().toISOString().slice(0, 10)}.csv`;
                }
                
                // Create blob and download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                // Use URL.createObjectURL for modern browser compatibility
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    // For IE
                    window.navigator.msSaveOrOpenBlob(blob, filename);
                } else {
                    // For other browsers
                    link.href = URL.createObjectURL(blob);
                    link.setAttribute('download', filename);
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);
                    }, 100);
                }
            } catch (error) {
                console.error("Error exporting CSV:", error);
                alert(currentLocale === 'en' ? 
                      "Could not export data. Error: " + error.message : 
                      "Não foi possível exportar os dados. Erro: " + error.message);
            }
        }
        
        // Event to share
        function shareSurvey() {
            const link = document.getElementById('survey-link')?.value;
            if (!link) return;
            
            if (navigator.share) {
                navigator.share({
                    title: currentLocale === 'en' ? 'Availability Survey' : 'Pesquisa de Disponibilidade',
                    text: currentLocale === 'en' ? 
                          `Please participate in the availability survey: ${surveyData?.survey?.title || 'Survey'}` : 
                          `Por favor, participe da pesquisa de disponibilidade: ${surveyData?.survey?.title || 'Pesquisa'}`,
                    url: link
                })
                .catch(err => {
                    console.log('Error sharing:', err);
                    copyToClipboard('survey-link');
                });
            } else {
                copyToClipboard('survey-link');
            }
        }
        
        // Event to export data
        document.getElementById('export-btn').addEventListener('click', exportToCSV);
        if (exportResultsBtn) exportResultsBtn.addEventListener('click', exportToCSV);
        
        // Event to share
        document.getElementById('share-btn').addEventListener('click', shareSurvey);
        if (shareSurveyBtn) shareSurveyBtn.addEventListener('click', shareSurvey);
        
        // Event for participant search
        if (participantSearch) {
            participantSearch.addEventListener('input', function() {
                if (surveyData && surveyData.participants) {
                    updateParticipantsList(surveyData.participants, this.value);
                }
            });
        }
        
        // Event to highlight availabilities
        if (highlightSwitch) {
            highlightSwitch.addEventListener('change', function() {
                const dayElements = document.querySelectorAll('.highlight-participants');
                dayElements.forEach(el => {
                    if (this.checked) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                });
            });
        }
        
        function initEmptyCalendar() {
            if (!calendarEl) return;
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridYear'
                },
                locale: currentLocale.substring(0, 2),
                height: 'auto'
            });
            
            calendar.render();
        }
        
        function handleApiError(response) {
            console.error('API Error:', response.status);
            showErrorMessage(currentLocale === 'en' ? 
                'Error loading survey data. Please try again.' : 
                'Erro ao carregar dados da survey. Por favor, tente novamente.');
        }
        
        function showErrorMessage(message) {
            const cardBody = document.querySelector('.card-body');
            if (!cardBody) return;
            
            const alertElement = document.createElement('div');
            alertElement.className = 'alert alert-danger alert-dismissible fade show';
            alertElement.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>${currentLocale === 'en' ? 'Error:' : 'Erro:'}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            cardBody.prepend(alertElement);
            
            setTimeout(() => {
                alertElement.classList.add('fade');
                setTimeout(() => alertElement.remove(), 300);
            }, 5000);
        }
        
        function updateSurveyInfo(surveyInfo) {
            // Update creation and expiry dates
            if (creationDate) creationDate.textContent = formatDate(surveyInfo.created_at);
            if (expiryDate) expiryDate.textContent = formatDate(surveyInfo.expires_at);
        }
        
        // Load survey data
        async function loadSurveyData() {
            try {
                // Get current survey token from URL
                const pathParts = window.location.pathname.split('/');
                const surveyToken = pathParts[pathParts.length - 1];
                
                // First get basic survey info
                const surveyInfoResponse = await fetch(`/api/survey-info/${surveyToken}`, {
                    headers: { 'X-CSRFToken': window.csrfToken || '' }
                });
                
                if (surveyInfoResponse.ok) {
                    const surveyInfo = await surveyInfoResponse.json();
                    
                    // Update basic info
                    updateSurveyInfo(surveyInfo);
                    
                    // Initialize empty calendar
                    initEmptyCalendar();
                    
                    // Get full data with participants
                    const response = await fetch(`/api/survey-data/${surveyToken}`, {
                        headers: { 'X-CSRFToken': window.csrfToken || '' }
                    });
                    
                    if (response.ok) {
                        surveyData = await response.json();
                        
                        // Update participants count
                        if (participantsCount) {
                            participantsCount.textContent = Object.keys(surveyData.participants || {}).length;
                        }
                        
                        // Update calendar with availability data
                        initCalendar(surveyData);
                        
                        // Update participants list
                        updateParticipantsList(surveyData.participants);
                    } else {
                        handleApiError(response);
                    }
                } else {
                    handleApiError(surveyInfoResponse);
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorMessage(currentLocale === 'en' ? 
                    'Error communicating with server. Please try again.' : 
                    'Erro ao comunicar com o servidor. Por favor, tente novamente.');
            }
        }
        
        // Load data on page load
        loadSurveyData();
    });
</script>
{% endblock %}